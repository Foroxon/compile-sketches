# See: https://taskfile.dev/#/usage
version: "3"

vars:
  PYTHON_PROJECT_PATH: compilesketches

tasks:
  check:
    desc: Check for problems with the project
    deps:
      - task: action:validate
      - task: general:check-formatting
      - task: general:check-spelling
      - task: python:lint
      - task: python:test

  fix:
    desc: Make automated corrections to the project's files
    deps:
      - task: general:correct-spelling
      - task: python:format

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/check-action-metadata-task/Taskfile.yml
  action:validate:
    desc: Validate GitHub Actions metadata against JSON schema
    vars:
      ACTION_METADATA_SCHEMA_PATH:
        sh: task utility:mktemp-file TEMPLATE="github-action-schema-XXXXXXXXXX.json"
    deps:
      - task: npm:install-deps
    cmds:
      - |
        wget \
          --quiet \
          --output-document="{{.ACTION_METADATA_SCHEMA_PATH}}" \
          https://json.schemastore.org/github-action
      - |
        npx \
          ajv-cli \
            validate \
            --strict=false \
            -s "{{.ACTION_METADATA_SCHEMA_PATH}}" \
            -d "action.yml"

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/check-files-task/Taskfile.yml
  general:check-filenames:
    desc: Check for non-portable filenames
    cmds:
      - |
        find . \
          -type d -name '.git' -prune -o \
          -type d -name '.licenses' -prune -o \
          -type d -name '__pycache__' -prune -o \
          -type d -name 'node_modules' -prune -o \
          -exec \
            sh \
              -c \
                ' \
                  basename "$0" | \
                    grep \
                      --perl-regexp \
                      --regexp='"'"'([<>:"/\\|?*\x{0000}-\x{001F}])|(.+\.$)'"'"' \
                      --silent \
                  && \
                  echo "$0"
                ' \
              '{}' \
            \; \
          -execdir \
            false \
            '{}' \
            + \
        || \
        {
          echo
          echo "Prohibited characters found in filenames"
          echo "See:"
          echo "https://learn.microsoft.com/en-us/windows/win32/fileio/naming-a-file#naming-conventions:~:text=except%20for%20the%20following"
          false
        }
      - |
        find . \
          -type d -name '.git' -prune -o \
          -type d -name '.licenses' -prune -o \
          -type d -name '__pycache__' -prune -o \
          -type d -name 'node_modules' -prune -o \
          -exec \
            sh \
              -c \
                ' \
                  basename "$0" | \
                    grep \
                      --ignore-case \
                      --extended-regexp \
                      --regexp='"'"'^(con|prn|aux|nul|com[0-9]+|lpt[0-9]+)$'"'"' \
                      --silent \
                  && \
                  echo "$0"
                ' \
              '{}' \
            \; \
          -execdir \
            false \
            '{}' \
            + \
        || \
        {
          echo
          echo "Reserved filenames found"
          echo "See:"
          echo "https://learn.microsoft.com/en-us/windows/win32/fileio/naming-a-file#naming-conventions:~:text=use%20the%20following-,reserved%20names,-for%20the%20name"
          false
        }

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/check-general-formatting-task/Taskfile.yml
  general:check-formatting:
    desc: Check basic formatting style of all files
    cmds:
      - |
        if ! which ec &>/dev/null; then
          echo "ec not found or not in PATH."
          echo "Please install: https://github.com/editorconfig-checker/editorconfig-checker#installation"
          exit 1
        fi
      - ec

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/spell-check-task/Taskfile.yml
  general:check-spelling:
    desc: Check for commonly misspelled words
    deps:
      - task: poetry:install-deps
        vars:
          POETRY_GROUPS: dev
    cmds:
      - poetry run codespell

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/check-files-task/Taskfile.yml
  general:check-symlinks:
    desc: Check for bad symlinks
    cmds:
      - |
        find . \
          -type d -name '.git' -prune -o \
          -type d -name '.licenses' -prune -o \
          -type d -name '__pycache__' -prune -o \
          -type d -name 'node_modules' -prune -o \
          -type l \
          -execdir \
            test ! -e '{}' \
            \; \
          -exec \
            echo '{}' \
            \; \
          -execdir \
            false \
            '{}' \
            + \
        || \
        {
          echo 'Broken or circular symlink found'
          false
        }

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/spell-check-task/Taskfile.yml
  general:correct-spelling:
    desc: Correct commonly misspelled words where possible
    deps:
      - task: poetry:install-deps
        vars:
          POETRY_GROUPS: dev
    cmds:
      - poetry run codespell --write-changes

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/npm-task/Taskfile.yml
  npm:install-deps:
    desc: Install dependencies managed by npm
    run: once
    cmds:
      - npm install

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/poetry-task/Taskfile.yml
  poetry:install-deps:
    desc: Install dependencies managed by Poetry
    run: when_changed
    cmds:
      - |
        poetry install \
          --no-root \
          {{if .POETRY_GROUPS}} --only {{.POETRY_GROUPS}} {{end}}

  python:coverage-report:
    desc: Show code coverage report
    deps:
      - task: poetry:install-deps
        vars:
          POETRY_GROUPS: dev
    cmds:
      - |
        poetry run \
          coverage report

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/check-python-task/Taskfile.yml
  python:format:
    desc: Format Python files
    deps:
      - task: poetry:install-deps
        vars:
          POETRY_GROUPS: dev
    cmds:
      - poetry run black .

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/check-python-task/Taskfile.yml
  python:lint:
    desc: Lint Python code
    deps:
      - task: poetry:install-deps
        vars:
          POETRY_GROUPS: dev
    cmds:
      - poetry run flake8 --show-source

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/test-python-poetry-task/Taskfile.yml
  python:test:
    desc: Run Python tests
    deps:
      - task: poetry:install-deps
        vars:
          POETRY_GROUPS: dev,main
    cmds:
      - |
        export PYTHONPATH="${PWD}/{{.PYTHON_PROJECT_PATH}}"
        poetry run \
          coverage run \
            --source="{{.PYTHON_PROJECT_PATH}}" \
            --module \
              pytest "{{.PYTHON_PROJECT_PATH}}/tests"

  # Make a temporary file named according to the passed TEMPLATE variable and print the path passed to stdout
  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/windows-task/Taskfile.yml
  utility:mktemp-file:
    vars:
      RAW_PATH:
        sh: mktemp --tmpdir "{{.TEMPLATE}}"
    cmds:
      - task: utility:normalize-path
        vars:
          RAW_PATH: "{{.RAW_PATH}}"

  # Make a temporary folder named according to the passed TEMPLATE variable and print the path passed to stdout
  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/windows-task/Taskfile.yml
  utility:mktemp-folder:
    vars:
      RAW_PATH:
        sh: mktemp --directory --tmpdir "{{.TEMPLATE}}"
    cmds:
      - task: utility:normalize-path
        vars:
          RAW_PATH: "{{.RAW_PATH}}"

  # Print a normalized version of the path passed via the RAW_PATH variable to stdout
  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/windows-task/Taskfile.yml
  utility:normalize-path:
    cmds:
      - |
        if [[ "{{.OS}}" == "Windows_NT" ]] && which cygpath &>/dev/null; then
            # Even though the shell handles POSIX format absolute paths as expected, external applications do not.
            # So paths passed to such applications must first be converted to Windows format.
            cygpath -w "{{.RAW_PATH}}"
        else
          echo "{{.RAW_PATH}}"
        fi
